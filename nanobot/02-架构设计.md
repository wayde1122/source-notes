# nanobot 架构设计

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                       CLI (commands.py)                         │
│  nanobot gateway / nanobot agent — 系统编排入口                  │
└───────┬───────────────────────────────────────────────┬─────────┘
        │                                               │
        ▼                                               ▼
┌───────────────┐    InboundMessage     ┌──────────────────────┐
│   Channels    │ ──────────────────►   │     MessageBus       │
│  渠道层       │                       │    异步消息总线       │
│  (9 个平台)   │ ◄──────────────────   │  inbound / outbound  │
└───────────────┘    OutboundMessage    └──────────┬───────────┘
                                                   │
                                                   ▼
                                        ┌──────────────────────┐
                                        │     AgentLoop        │
                                        │    核心处理引擎       │
                                        │                      │
                                        │  ┌────────────────┐  │
                                        │  │ ContextBuilder  │  │
                                        │  │ (提示词构建)    │  │
                                        │  └────────────────┘  │
                                        │  ┌────────────────┐  │
                                        │  │  ToolRegistry   │  │
                                        │  │ (工具执行)      │  │
                                        │  └────────────────┘  │
                                        │  ┌────────────────┐  │
                                        │  │ SessionManager  │  │
                                        │  │ (会话管理)      │  │
                                        │  └────────────────┘  │
                                        │  ┌────────────────┐  │
                                        │  │  MemoryStore    │  │
                                        │  │ (双层记忆)      │  │
                                        │  └────────────────┘  │
                                        └──────────┬───────────┘
                                                   │
                              ┌─────────────────────┼──────────────────────┐
                              ▼                     ▼                      ▼
                     ┌──────────────┐     ┌──────────────┐     ┌──────────────────┐
                     │ LLMProvider  │     │  CronService │     │ HeartbeatService │
                     │ (LiteLLM)   │     │  (定时任务)   │     │  (周期唤醒)       │
                     └──────────────┘     └──────────────┘     └──────────────────┘
```

## 核心设计模式

### 1. 事件驱动（Event-Driven）

MessageBus 使用 `asyncio.Queue` 实现入站/出站两条消息队列，将渠道层和 Agent 层完全解耦：

- **入站流**：Channel → `publish_inbound()` → Queue → `consume_inbound()` → AgentLoop
- **出站流**：AgentLoop → `publish_outbound()` → Queue → `dispatch_outbound()` → Channel

好处：添加新渠道不需要修改 Agent 代码，反之亦然。

### 2. 策略模式（Strategy Pattern）

三个核心抽象接口，实现可替换：

| 接口          | 实现                           | 职责       |
| ------------- | ------------------------------ | ---------- |
| `LLMProvider` | `LiteLLMProvider`              | LLM 调用   |
| `BaseChannel` | Telegram / Discord / QQ 等     | 平台接入   |
| `Tool`        | ReadFile / Exec / WebSearch 等 | Agent 工具 |

### 3. 注册表模式（Registry Pattern）

- `ToolRegistry`：工具的动态注册/注销/执行
- `PROVIDERS`（ProviderSpec 元组）：提供商元数据集中管理
- `ChannelManager`：渠道的初始化/启停/路由

所有扩展点都只需 **"注册一个条目"** 即可完成集成，无需修改核心代码。

### 4. 模板方法模式（Template Method）

`BaseChannel._handle_message()` 定义了消息处理模板：

```
收到消息 → is_allowed() 权限检查 → 封装 InboundMessage → publish_inbound()
```

所有渠道共享这个流程，只需各自实现 `start()` / `stop()` / `send()`。

## 关键数据流：一条消息的完整生命周期

```
用户在 Telegram 发送 "帮我搜索最新新闻"
    │
    ▼
TelegramChannel._on_message()
    │  构建 sender_id / chat_id / content
    │  启动 typing 指示器
    ▼
BaseChannel._handle_message()
    │  is_allowed() 权限检查
    │  封装为 InboundMessage
    ▼
MessageBus.publish_inbound()
    │
    ▼
AgentLoop.run() → consume_inbound()
    │
    ▼
AgentLoop._process_message()
    │
    ├─ 1. 获取 Session（channel:chat_id）
    ├─ 2. 检查斜杠命令（/new、/help）
    ├─ 3. 记忆压缩（超过 50 条时触发）
    ├─ 4. ContextBuilder.build_messages()
    │     ├─ 系统提示（身份 + 引导文件 + 记忆 + 技能）
    │     ├─ 历史消息
    │     └─ 当前用户消息
    │
    ├─ 5. Agent 循环（最多 20 次迭代）
    │     ├─ LLMProvider.chat() → 调用 LLM
    │     ├─ 有工具调用？
    │     │   ├─ 是 → ToolRegistry.execute() → 加入反思提示 → 继续循环
    │     │   └─ 否 → 提取最终回复 → 退出循环
    │
    ├─ 6. 保存会话
    └─ 7. 发布 OutboundMessage
              │
              ▼
         MessageBus.publish_outbound()
              │
              ▼
         ChannelManager._dispatch_outbound()
              │
              ▼
         TelegramChannel.send()
              │  Markdown → Telegram HTML 转换
              │  停止 typing 指示器
              ▼
         用户收到回复
```

## 组件依赖关系

```
CLI (commands.py)
 ├── Config (load_config)
 ├── MessageBus
 ├── AgentLoop
 │    ├── ContextBuilder
 │    │    ├── MemoryStore
 │    │    └── SkillsLoader
 │    ├── ToolRegistry
 │    │    └── Tool 实现（filesystem / shell / web / message / spawn / cron）
 │    ├── SessionManager
 │    ├── SubagentManager
 │    └── LLMProvider
 ├── ChannelManager
 │    └── BaseChannel 实现（telegram / discord / whatsapp 等）
 ├── CronService
 └── HeartbeatService
```
