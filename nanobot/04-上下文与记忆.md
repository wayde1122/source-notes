# 上下文构建与记忆系统

## ContextBuilder（agent/context.py）

负责将各种信息组装成 LLM 能理解的消息列表。

### 系统提示的四层组装

```python
def build_system_prompt(self):
    parts = []
    parts.append(self._get_identity())          # 1. 核心身份
    parts.append(self._load_bootstrap_files())   # 2. 引导文件
    parts.append(self.memory.get_memory_context())# 3. 长期记忆
    parts.append(skills_content)                 # 4. 技能
    return "\n\n---\n\n".join(parts)
```

#### 第 1 层：核心身份（_get_identity）

注入以下运行时信息：
- 当前时间和时区
- 操作系统和 Python 版本
- 工作空间路径
- 可用工具的概要说明
- 行为指令（何时直接回复 vs 使用工具）

#### 第 2 层：引导文件（_load_bootstrap_files）

从 workspace 加载 5 个 Markdown 文件（存在才加载）：

| 文件        | 用途           |
| ----------- | -------------- |
| AGENTS.md   | Agent 行为指令 |
| SOUL.md     | 人格/性格定义  |
| USER.md     | 用户偏好信息   |
| TOOLS.md    | 工具使用指南   |
| IDENTITY.md | 自定义身份描述 |

用户可以通过编辑这些文件来定制 Agent 的行为。

#### 第 3 层：长期记忆

从 `MEMORY.md` 读取内容，包含 LLM 自动维护的长期事实（用户偏好、重要信息等）。

#### 第 4 层：技能（渐进式加载）

- **始终加载的技能**（`always=true`）：完整内容直接注入系统提示
- **可用技能列表**：以 XML 格式呈现摘要，Agent 需要时通过 `read_file` 工具自行读取全文

### 消息列表构建（build_messages）

最终组装：`[system_prompt] + [history...] + [current_message]`

当前消息支持多模态：图片文件被 base64 编码后以 OpenAI Vision API 格式传递。

### 思维模型兼容

`add_assistant_message()` 保留 `reasoning_content` 字段，兼容 DeepSeek-R1、Kimi 等思维模型。不带该字段的消息历史会导致这些模型报错。

---

## MemoryStore（agent/memory.py）

极简的双层记忆系统（仅 31 行代码）：

### 两层设计

| 层       | 文件       | 读写方式         | 用途                     |
| -------- | ---------- | ---------------- | ------------------------ |
| 长期记忆 | MEMORY.md  | 全量读/覆盖写    | 事实型信息（偏好、习惯） |
| 历史日志 | HISTORY.md | 追加写（append） | 时间线（可 grep 搜索）   |

### 工作方式

1. 长期记忆注入系统提示，Agent 始终可见
2. 历史日志不注入系统提示，Agent 通过 `exec` 工具执行 `grep` 来搜索
3. 会话超过 memory_window 时，LLM 自动压缩旧消息到两层记忆

### 压缩策略

- 保留最近的 `memory_window / 2`（最少 2 条、最多 10 条）消息
- 被压缩的消息由 LLM 生成 JSON：
  - `history_entry`：带时间戳的事件摘要（追加到 HISTORY.md）
  - `memory_update`：更新后的长期记忆（覆盖 MEMORY.md）

---

## SkillsLoader（agent/skills.py）

### 技能是什么

技能是 Markdown 文件（`SKILL.md`），教 Agent 如何完成特定任务。

### 技能来源（优先级从高到低）

1. **工作空间技能**：`~/.nanobot/workspace/skills/{name}/SKILL.md`
2. **内置技能**：`nanobot/skills/{name}/SKILL.md`

同名时工作空间版本覆盖内置版本。

### 内置技能列表

| 技能名        | 用途          |
| ------------- | ------------- |
| github        | GitHub 操作   |
| weather       | 天气查询      |
| summarize     | 内容摘要      |
| tmux          | tmux 会话管理 |
| memory        | 记忆操作      |
| cron          | 定时任务      |
| skill-creator | 创建新技能    |

### 渐进式加载策略

- 标记为 `always=true` 的技能：完整内容注入系统提示
- 其余技能：仅在系统提示中显示 XML 摘要（名称 + 描述 + 路径 + 是否可用）
- Agent 需要时通过 `read_file` 工具加载全文

### 依赖检查

技能可在 frontmatter 中声明依赖：

```yaml
---
metadata: '{"nanobot": {"requires": {"bins": ["gh"], "env": ["GITHUB_TOKEN"]}}}'
---
```

缺少 CLI 工具或环境变量时，技能标记为 `available="false"`。
